/*! For license information please see module.js.LICENSE.txt */
define(["react","@grafana/data","@grafana/ui","@grafana/runtime","emotion"],(function(e,t,a,n,r){return function(e){var t={};function a(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,a),r.l=!0,r.exports}return a.m=e,a.c=t,a.d=function(e,t,n){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)a.d(n,r,function(t){return e[t]}.bind(null,r));return n},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="/",a(a.s=6)}([function(t,a){t.exports=e},function(e,a){e.exports=t},function(e,t){e.exports=a},function(e,t){e.exports=n},function(e,t){e.exports=r},function(e,t,a){"use strict";a.d(t,"a",(function(){return n}));var n=function(){return(n=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};Object.create;Object.create},function(e,t,a){"use strict";a.r(t);var n=a(1),r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var a in t)t.hasOwnProperty(a)&&(e[a]=t[a])})(e,t)};function i(e,t){function a(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(a.prototype=t.prototype,new a)}var l=function(){return(l=Object.assign||function(e){for(var t,a=1,n=arguments.length;a<n;a++)for(var r in t=arguments[a])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function o(e,t,a,n){return new(a||(a=Promise))((function(r,i){function l(e){try{u(n.next(e))}catch(e){i(e)}}function o(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof a?t:new a((function(e){e(t)}))).then(l,o)}u((n=n.apply(e,t||[])).next())}))}function u(e,t){var a,n,r,i,l={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return i={next:o(0),throw:o(1),return:o(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function o(i){return function(o){return function(i){if(a)throw new TypeError("Generator is already executing.");for(;l;)try{if(a=1,n&&(r=2&i[0]?n.return:i[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,i[1])).done)return r;switch(n=0,r&&(i=[2&i[0],r.value]),i[0]){case 0:case 1:r=i;break;case 4:return l.label++,{value:i[1],done:!1};case 5:l.label++,n=i[1],i=[0];continue;case 7:i=l.ops.pop(),l.trys.pop();continue;default:if(!(r=l.trys,(r=r.length>0&&r[r.length-1])||6!==i[0]&&2!==i[0])){l=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){l.label=i[1];break}if(6===i[0]&&l.label<r[1]){l.label=r[1],r=i;break}if(r&&l.label<r[2]){l.label=r[2],l.ops.push(i);break}r[2]&&l.ops.pop(),l.trys.pop();continue}i=t.call(e,l)}catch(e){i=[6,e],n=0}finally{a=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,o])}}}function s(e){var t="function"==typeof Symbol&&Symbol.iterator,a=t&&e[t],n=0;if(a)return a.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function c(e,t){var a="function"==typeof Symbol&&e[Symbol.iterator];if(!a)return e;var n,r,i=a.call(e),l=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)l.push(n.value)}catch(e){r={error:e}}finally{try{n&&!n.done&&(a=i.return)&&a.call(i)}finally{if(r)throw r.error}}return l}function d(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var m,f,v,h,p,g,y,b,_,E,T=a(0),S=a.n(T);!function(e){e.OAuth="oauth",e.RefreshToken="refresh_token"}(m||(m={})),function(e){e.Meters="meters",e.Feet="feet"}(f||(f={})),function(e){e.TimeSeries="time_series",e.Table="table",e.WorldMap="worldmap",e.Heatmap="heatmap"}(v||(v={})),function(e){e.No="no",e.Auto="auto",e.Hour="hour",e.Day="day",e.Week="week",e.Month="month"}(h||(h={})),function(e){e.Activities="Activities",e.Activity="Activity",e.SegmentEffort="SegmentEffort"}(p||(p={})),function(e){e.Distance="distance",e.MovingTime="moving_time",e.ElapsedTime="elapsed_time",e.ElevationGain="total_elevation_gain",e.AveragePower="average_watts",e.WeightedAveragePower="weighted_average_watts",e.AverageHeartRate="average_heartrate"}(g||(g={})),function(e){e.Graph="graph",e.Splits="splits",e.Stats="stats",e.Geomap="geomap",e.Segments="segments"}(y||(y={})),function(e){e.Pace="pace",e.HeartRate="average_heartrate",e.Speed="average_speed",e.MovingTime="moving_time",e.ElapsedTime="elapsed_time"}(b||(b={})),function(e){e.Distance="distance",e.HeartRate="heartrate",e.Altitude="altitude",e.Cadence="cadence",e.Velocity="velocity_smooth",e.Pace="pace",e.Watts="watts",e.WattsCalc="watts_calc",e.Temp="temp",e.Moving="moving",e.GradeSmooth="grade_smooth",e.GradeAdjustedDistance="grade_adjusted_distance",e.LatLng="latlng"}(_||(_={})),function(e){e.Activity="activity",e.SegmentEffort="segment_effort"}(E||(E={}));var w=a(2),A=a(3),F=function(){function e(e){this.datasourceId=e,this.backendAPIUrl="/api/datasources/"+this.datasourceId+"/resources/strava-api",this.backendAuthUrl="/api/datasources/"+this.datasourceId+"/resources/auth",this.promises={},this.apiUrl=""}return e.prototype.getAuthenticatedAthlete=function(){return o(this,void 0,Promise,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,this.tsdbRequest("athlete")];case 1:return[2,e.sent()]}}))}))},e.prototype.getActivities=function(e){return o(this,void 0,Promise,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.requestWithPagination("athlete/activities",e)];case 1:return[2,t.sent()]}}))}))},e.prototype.getActivity=function(e){return o(this,void 0,void 0,(function(){var t,a;return u(this,(function(n){switch(n.label){case 0:return t=e.id,a=e.include_all_efforts,[4,this.tsdbRequest("/activities/"+t,{include_all_efforts:a})];case 1:return[2,n.sent()]}}))}))},e.prototype.getActivityStreams=function(e){return o(this,void 0,void 0,(function(){var t,a;return u(this,(function(n){switch(n.label){case 0:return t=e.id,a=e.streamType,[4,this.tsdbRequest("/activities/"+t+"/streams",{key_by_type:!0,keys:a+",time"})];case 1:return[2,n.sent()]}}))}))},e.prototype.getSegment=function(e){return o(this,void 0,Promise,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.tsdbRequest("/segments/"+e)];case 1:return[2,t.sent()]}}))}))},e.prototype.requestWithPagination=function(e,t){return o(this,void 0,void 0,(function(){var a,n,r,i,o;return u(this,(function(u){switch(u.label){case 0:a=[],n=[],r=1,i=t&&t.limit,o=t&&t.per_page||200,i&&(o=Math.min(o,i)),u.label=1;case 1:if(0===n.length&&1!==r||i&&a.length>=i)return[3,6];t=l(l({},t),{per_page:o,page:r}),u.label=2;case 2:return u.trys.push([2,4,,5]),[4,this.tsdbRequest(e,t)];case 3:return n=u.sent(),[3,5];case 4:throw u.sent();case 5:return a=a.concat(n),r++,[3,1];case 6:return[2,a]}}))}))},e.prototype.exchangeToken=function(e){return o(this,void 0,void 0,(function(){return u(this,(function(t){switch(t.label){case 0:return[4,this.tsdbAuthRequest({authCode:e})];case 1:return[2,t.sent()]}}))}))},e.prototype.resetAccessToken=function(){return o(this,void 0,void 0,(function(){var e;return u(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,Object(A.getBackendSrv)().get("/api/datasources/"+this.datasourceId+"/resources/reset-access-token")];case 1:return e=t.sent(),[2,this.handleTsdbResponse(e)];case 2:throw t.sent();case 3:return[2]}}))}))},e.prototype.resetCache=function(){return o(this,void 0,void 0,(function(){var e;return u(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,Object(A.getBackendSrv)().get("/api/datasources/"+this.datasourceId+"/resources/reset-cache")];case 1:return e=t.sent(),[2,this.handleTsdbResponse(e)];case 2:throw t.sent();case 3:return[2]}}))}))},e.prototype.request=function(e,t){return o(this,void 0,void 0,(function(){return u(this,(function(a){return[2,this.proxyfy(this._request,"_request",this)(e,t)]}))}))},e.prototype._request=function(e,t){return o(this,void 0,void 0,(function(){return u(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,Object(A.getBackendSrv)().datasourceRequest({url:this.apiUrl+"/strava/"+e,method:"GET",params:t})];case 1:return[2,a.sent().data];case 2:throw a.sent();case 3:return[2]}}))}))},e.prototype.tsdbRequest=function(e,t){return o(this,void 0,void 0,(function(){return u(this,(function(a){return[2,this.proxyfy(this._tsdbRequest,"_tsdbRequest",this)(e,t)]}))}))},e.prototype._tsdbRequest=function(e,t){return o(this,void 0,void 0,(function(){var a;return u(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,Object(A.getBackendSrv)().datasourceRequest({url:this.backendAPIUrl,method:"POST",headers:{"Content-Type":"application/json"},data:{datasourceId:this.datasourceId,endpoint:e,params:t}})];case 1:return a=n.sent(),[2,this.handleTsdbResponse(a)];case 2:throw n.sent();case 3:return[2]}}))}))},e.prototype.tsdbAuthRequest=function(e){return o(this,void 0,void 0,(function(){var t,a;return u(this,(function(n){switch(n.label){case 0:t="stravaAuth",n.label=1;case 1:return n.trys.push([1,3,,4]),[4,Object(A.getBackendSrv)().datasourceRequest({url:this.backendAuthUrl,method:"POST",data:e})];case 2:return a=n.sent(),[2,this.handleTsdbResponse(a,t)];case 3:throw n.sent();case 4:return[2]}}))}))},e.prototype.handleTsdbResponse=function(e,t){if(void 0===t&&(t="stravaAPI"),e&&(e.status>=400||e.status<0))throw Error(e.statusText);if(!e||!e.data||!e.data.result)return[];var a=e.data.result;if(a.error)throw Error(a.error);return a},e.prototype.proxyfy=function(e,t,a){return this.promises[t]||(this.promises[t]={}),function(e,t,a){return function(){var n=I(arguments);return t[n]||(t[n]=Promise.resolve(e.apply(a,arguments).then((function(e){return t[n]=null,e})))),t[n]}}(e,this.promises[t],a)},e}();function I(e){return function(e){var t,a,n,r=0;if(0!==e.length)for(t=0,n=e.length;t<n;t++)a=e.charCodeAt(t),r=(r<<5)-r+a,r|=0;return r}(JSON.stringify(e))}function D(e){return 1&e?~(e>>>1):e>>>1}var C={decode:function(e){var t=[],a=0,n=0;return function(e,t){for(var a=0,n=0,r=0,i=0,l=0,o=0,u=0;u<e.length;u++)i=e.charCodeAt(u)-63,l|=(31&i)<<o,o+=5,i<32&&(1&++a?n=D(l):(r=D(l),t(n,r)),l=0,o=0)}(e,(function(e,r){a+=e,n+=r,t.push([a/1e5,n/1e5])})),t}};function R(e){return e/.3048}function P(e){return e/1609.344}function x(e){return 1609.344*e/1e3}function j(e){if(0===e)return 0;var t=Math.fround(1e3/e);return Math.min(600,t)}function M(e){return 3.6*e}function O(e,t){for(var a=0;a<e.length;a++){var n=e[a];if(null!=n){var r=j(n);e[a]=t===f.Feet?x(r):r}}return e}function k(e,t){for(var a=0;a<e.length;a++){var n=e[a];if(null!=n){var r=M(n);e[a]=t===f.Feet?P(1e3*r):r}}return e}function q(e,t){for(var a=0;a<e.length;a++){var n=e[a];null!=n&&(e[a]=t===f.Feet?R(n):n)}return e}function L(e){for(var t=Math.min(20,e.length),a=[],n=0,r=0,i=null,l=t;l>0;l--)null!=(i=e[t-l])&&(n+=i,r++);for(l=0;l<t;l++)a.push(n/r);for(l=t;l<e.length;l++){n=0,r=0;for(var o=0;o<t;o++)null!=(i=e[l-o])&&(n+=i,r++);a.push(n/r)}return a}var G={from:Object(n.dateTime)(),to:Object(n.dateTime)(),raw:{from:"now",to:"now"}},N=function(e){function t(t){var a=e.call(this,t)||this;return a.type="strava",a.datasourceId=t.id,a.apiUrl=t.url,a.stravaApi=new F(a.datasourceId),a.activities=[],a.stravaAuthType=t.jsonData.stravaAuthType,a.measurementPreference=f.Meters,a}return i(t,e),t.prototype.query=function(e){var t,a,n;return o(this,void 0,void 0,(function(){var r,i,l,o,c,d,m,h,g,y,b,_,E,T,S,w,A,F;return u(this,(function(u){switch(u.label){case 0:return r=[],i=[],this.athlete?[3,2]:(l=this,[4,this.stravaApi.getAuthenticatedAthlete()]);case 1:l.athlete=u.sent(),this.measurementPreference=(null===(t=this.athlete)||void 0===t?void 0:t.measurement_preference)||f.Meters,u.label=2;case 2:return e.targets.some((function(e){return e.queryType===p.Activities}))?(o=null===(a=e.range)||void 0===a?void 0:a.to.unix(),c=null===(n=e.range)||void 0===n?void 0:n.from.unix(),o=300*Math.floor(o/300),c=300*Math.floor(c/300),[4,this.stravaApi.getActivities({before:o,after:c})]):[3,4];case 3:i=u.sent(),u.label=4;case 4:u.trys.push([4,12,13,14]),d=s(e.targets),m=d.next(),u.label=5;case 5:if(m.done)return[3,11];if((h=m.value).hide)return[3,10];if(h.queryType!==p.Activities)return[3,6];switch(g=this.filterActivities(i,h.activityType),h.format){case v.Table:y=this.transformActivitiesToTable(g,h),r.push(y);break;case v.WorldMap:b=this.transformActivitiesToGeomap(g,h),r.push(b);break;case v.Heatmap:_=this.transformActivitiesToHeatmap(g,h),r.push(_);break;default:E=this.transformActivitiesToTimeseries(g,h,e.range||G),r.push(E)}return[3,10];case 6:return h.queryType!==p.Activity?[3,8]:[4,this.queryActivity(e,h)];case 7:return T=u.sent(),r.push(T),[3,10];case 8:return h.queryType!==p.SegmentEffort?[3,10]:[4,this.queryActivitySegment(e,h)];case 9:S=u.sent(),r.push(S),u.label=10;case 10:return m=d.next(),[3,5];case 11:return[3,14];case 12:return w=u.sent(),A={error:w},[3,14];case 13:try{m&&!m.done&&(F=d.return)&&F.call(d)}finally{if(A)throw A.error}return[7];case 14:return[2,{data:r}]}}))}))},t.prototype.queryActivity=function(e,t){var a,r,i;return o(this,void 0,void 0,(function(){var l,o,s,c,d,m,f,v,h,p,g,b,E;return u(this,(function(u){switch(u.label){case 0:return l=Object(A.getTemplateSrv)().replace(null===(a=t.activityId)||void 0===a?void 0:a.toString()),[4,this.stravaApi.getActivity({id:l,include_all_efforts:!0})];case 1:return o=u.sent(),t.activityData===y.Stats?[2,this.queryActivityStats(o,t,e)]:t.activityData===y.Splits?[2,this.queryActivitySplits(o,t,e)]:t.activityData===y.Geomap?[2,this.queryActivityGeomap(o,t,e)]:t.activityData===y.Segments?[2,this.queryActivitySegments(o,t,e)]:((s=t.activityGraph)===_.Pace&&(s=_.Velocity),s?[4,this.stravaApi.getActivityStreams({id:l,streamType:s})]:[2,null]);case 2:if(c=u.sent(),d={name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time,config:{custom:{}},values:new n.ArrayVector},m={name:s,type:n.FieldType.number,config:{custom:{}},values:new n.ArrayVector},f=new n.MutableDataFrame({name:o.name,refId:t.refId,fields:[]}),!(v=c[s]))return[2,f];for(h=Object(n.dateTime)(o.start_date).unix(),t.fitToTimeRange&&(h=e.range.from.unix()),p=c.time,g=(null===(r=c.time)||void 0===r?void 0:r.data[(null===(i=c.time)||void 0===i?void 0:i.data.length)-1])+1,b=new Array(g).fill(null),E=0;E<g;E++)d.values.add(1e3*h),b[p.data[E]]=v.data[E],h++;return t.activityGraph===_.Pace&&("Run"===o.type?(m.name="pace",m.config.unit="dthms",b=O(b,this.measurementPreference)):(m.name="speed",m.config.unit=te(this.measurementPreference),b=k(b,this.measurementPreference))),t.activityGraph===_.Velocity&&(m.name="speed",m.config.unit=te(this.measurementPreference),b=k(b,this.measurementPreference)),t.activityGraph===_.Altitude&&(m.config.unit=ae(this.measurementPreference),b=q(b,this.measurementPreference)),s!==_.Velocity&&s!==_.HeartRate&&s!==_.GradeSmooth&&s!==_.WattsCalc&&s!==_.Watts||(b=L(b)),m.values=new n.ArrayVector(b),f.addField(d),f.addField(m),[2,f]}}))}))},t.prototype.queryActivitySegment=function(e,t){var a,r,i;return o(this,void 0,void 0,(function(){var l,o,s,c,d,m,f,v,h,p,g,b,E,T,S,w,F;return u(this,(function(u){switch(u.label){case 0:return l=Object(A.getTemplateSrv)().replace(null===(a=t.activityId)||void 0===a?void 0:a.toString()),o=Object(A.getTemplateSrv)().replace(null===(r=t.segmentEffortId)||void 0===r?void 0:r.toString()),[4,this.stravaApi.getActivity({id:l,include_all_efforts:!0})];case 1:return s=u.sent(),(c=null===(i=s.segment_efforts)||void 0===i?void 0:i.find((function(e){return e.id.toString()===o})))?t.activityData===y.Geomap?[2,this.querySegmentGeomap(s,c,t,e)]:((d=t.segmentGraph)===_.Pace&&(d=_.Velocity),d?[4,this.stravaApi.getActivityStreams({id:l,streamType:d})]:[2,null]):[2,[]];case 2:if(m=u.sent(),f={name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time,config:{custom:{}},values:new n.ArrayVector},v={name:d,type:n.FieldType.number,config:{custom:{}},values:new n.ArrayVector},h=new n.MutableDataFrame({name:s.name,refId:t.refId,fields:[]}),!(p=m[d]))return[2,h];for(g=m.time,b=g.data[c.end_index]-g.data[c.start_index],E=new Array(b).fill(null),T=g.data[c.start_index],S=Object(n.dateTime)(s.start_date).unix()+T,t.fitToTimeRange&&(S=e.range.from.unix()),w=c.start_index,F=w;F<w+b;F++)f.values.add(1e3*S),S++;for(F=w;F<c.end_index;F++)E[g.data[F]-T]=p.data[F];return t.activityGraph===_.Pace&&("Run"===s.type?(v.name="pace",v.config.unit="dthms",E=O(E,this.measurementPreference)):(v.name="speed",v.config.unit=te(this.measurementPreference),E=k(E,this.measurementPreference))),t.activityGraph===_.Velocity&&(v.name="speed",v.config.unit=te(this.measurementPreference),E=k(E,this.measurementPreference)),t.activityGraph===_.Altitude&&(v.config.unit=ae(this.measurementPreference),E=q(E,this.measurementPreference)),d!==_.Velocity&&d!==_.HeartRate&&d!==_.GradeSmooth&&d!==_.WattsCalc&&d!==_.Watts||(E=L(E)),v.values=new n.ArrayVector(E),h.addField(f),h.addField(v),[2,h]}}))}))},t.prototype.queryActivitySplits=function(e,t,a){var r={name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time,config:{custom:{}},values:new n.ArrayVector},i=t.splitStat||"",l={name:i||n.TIME_SERIES_VALUE_FIELD_NAME,type:n.FieldType.number,config:{},values:new n.ArrayVector},o=new n.MutableDataFrame({name:e.name,refId:t.refId,fields:[]}),u=Object(n.dateTime)(e.start_date).unix();t.fitToTimeRange&&(u=a.range.from.unix());for(var s=this.measurementPreference===f.Meters?e.splits_metric:e.splits_standard,c=0;c<s.length;c++){var d=s[c];r.values.add(1e3*u);var m=d[i];i===b.Speed?m=M(m):i===b.Pace&&("Run"===e.type?(l.config.unit="dthms",m=ne(d[b.Speed],this.measurementPreference)):(l.config.unit=te(this.measurementPreference),m=ee(d[b.Speed],this.measurementPreference))),l.values.add(m),u+=d.elapsed_time}return o.addField(r),o.addField(l),o},t.prototype.queryActivityStats=function(e,t,a){var r,i,l,o,u,c=t.singleActivityStat||"name",d={name:c,type:n.FieldType.other,config:{},values:new n.ArrayVector},m=e[c];if(c.startsWith("gear_")){var v=c.substring("gear_".length);m=e.gear?e.gear[v]:null}if("pace"===c&&("Run"===e.type?(d.config.unit="dthms",m=ne(e.average_speed,this.measurementPreference)):(d.config.unit=te(this.measurementPreference),m=ee(e.average_speed,this.measurementPreference))),"top_achievement"===c){var h=null;try{for(var p=s(e.segment_efforts),y=p.next();!y.done;y=p.next()){var b=y.value;if(b.achievements)try{for(var _=(l=void 0,s(b.achievements)),E=_.next();!E.done;E=_.next()){var T=E.value;(null===h||T.rank<h)&&(h=T.rank)}}catch(e){l={error:e}}finally{try{E&&!E.done&&(o=_.return)&&o.call(_)}finally{if(l)throw l.error}}}}catch(e){r={error:e}}finally{try{y&&!y.done&&(i=p.return)&&i.call(p)}finally{if(r)throw r.error}}m=h}c===g.Distance&&(d.config.unit=this.measurementPreference===f.Feet?"lengthmi":"lengthm",m=X(e.distance,this.measurementPreference)),c===g.ElevationGain&&(d.config.unit=this.measurementPreference===f.Feet?"lengthft":"lengthm",m=Z(e.total_elevation_gain,this.measurementPreference));var S=new n.MutableDataFrame({name:e.name,refId:t.refId,fields:[{name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time},d]});return S.add(((u={time:Object(n.dateTime)(e.start_date)})[c]=m,u)),S},t.prototype.queryActivitySegments=function(e,t,a){var r,i;return o(this,void 0,void 0,(function(){var a,l,o,s,c,d,m,v,h=this;return u(this,(function(u){switch(u.label){case 0:return a=this.measurementPreference===f.Feet?"lengthmi":"lengthm",l=this.measurementPreference===f.Feet?"lengthft":"lengthm",o=new n.MutableDataFrame({refId:t.refId,fields:[{name:"name",type:n.FieldType.string},{name:"achievements",type:n.FieldType.number,config:{unit:"",decimals:0}},{name:"time",type:n.FieldType.number,config:{unit:"dthms"}},{name:"pace",type:n.FieldType.number,config:{unit:""}},{name:"heart rate",type:n.FieldType.number,config:{unit:"bpm",decimals:0}},{name:"power",type:n.FieldType.number,config:{unit:"watt"}},{name:"distance",type:n.FieldType.number,config:{unit:a}},{name:"elevation gain",type:n.FieldType.number,config:{unit:l,decimals:0}},{name:"grade",type:n.FieldType.number,config:{unit:"percent",decimals:1}},{name:"PR",type:n.FieldType.string,config:{unit:"dthms"}},{name:"KOM",type:n.FieldType.string},{name:"id",type:n.FieldType.string,config:{unit:"none",custom:{hidden:!0}}},{name:"segment_id",type:n.FieldType.string,config:{unit:"none",custom:{hidden:!0}}},{name:"time_from",type:n.FieldType.number,config:{unit:"none",decimals:0,custom:{hidden:!0}}},{name:"time_to",type:n.FieldType.number,config:{unit:"none",decimals:0,custom:{hidden:!0}}}]}),(null==(s=e.segment_efforts)?void 0:s.length)>0?[4,Promise.all(s.map((function(e){return h.stravaApi.getSegment(e.segment.id)})))]:[3,2];case 1:for(c=u.sent(),d=function(e){var t=s[e],a=c.find((function(e){return e.id===t.segment.id})),l=o.fields.findIndex((function(e){return"pace"===e.name})),u=void 0;"Run"===t.segment.activity_type?(o.fields[l].config.unit="dthms",u=ne(t.distance/t.moving_time,m.measurementPreference)):(o.fields[l].config.unit=te(m.measurementPreference),u=ee(t.distance/t.moving_time,m.measurementPreference));var d={name:t.name,achievements:t.pr_rank,time:t.moving_time,pace:u,"heart rate":t.average_heartrate,power:t.average_watts,distance:X(t.distance,m.measurementPreference),"elevation gain":Z(t.segment.elevation_high-t.segment.elevation_low,m.measurementPreference),grade:t.segment.average_grade,PR:null===(r=null==a?void 0:a.athlete_segment_stats)||void 0===r?void 0:r.pr_elapsed_time,KOM:null===(i=null==a?void 0:a.xoms)||void 0===i?void 0:i.overall,id:t.id,segment_id:t.segment.id,time_from:1e3*Object(n.dateTime)(t.start_date).unix(),time_to:1e3*(Object(n.dateTime)(t.start_date).unix()+t.elapsed_time)};o.add(d)},m=this,v=0;v<s.length;v++)d(v);u.label=2;case 2:return[2,o]}}))}))},t.prototype.queryActivityGeomap=function(e,t,a){var r,i;return o(this,void 0,void 0,(function(){var a,l,o,s,c,d,m,f,v;return u(this,(function(u){switch(u.label){case 0:a=new n.MutableDataFrame({name:e.name,refId:t.refId,fields:[{name:n.TIME_SERIES_VALUE_FIELD_NAME,type:n.FieldType.number},{name:"latitude",type:n.FieldType.number},{name:"longitude",type:n.FieldType.number}]}),l=[],o=null===(r=null==e?void 0:e.map)||void 0===r?void 0:r.polyline,l=C.decode(o),u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.stravaApi.getActivityStreams({id:e.id,streamType:_.LatLng})];case 2:if(s=u.sent(),l=s[_.LatLng].data,c=Object(n.dateTime)(e.start_date).unix(),!(d=null===(i=s.time)||void 0===i?void 0:i.data))throw new Error("Time field not found");for(a.addField({name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time}),m=0;m<l.length;m++)a.add(((f={latitude:l[m][0],longitude:l[m][1]})[n.TIME_SERIES_VALUE_FIELD_NAME]=1,f[n.TIME_SERIES_TIME_FIELD_NAME]=1e3*(c+d[m]),f));return[3,4];case 3:for(u.sent(),m=0;m<l.length;m++)a.add(((v={latitude:l[m][0],longitude:l[m][1]})[n.TIME_SERIES_VALUE_FIELD_NAME]=1,v));return[3,4];case 4:return[2,a]}}))}))},t.prototype.querySegmentGeomap=function(e,t,a,r){var i;return o(this,void 0,void 0,(function(){var r,l,o,s,c,d,m;return u(this,(function(u){switch(u.label){case 0:if(r=new n.MutableDataFrame({name:e.name,refId:a.refId,fields:[{name:n.TIME_SERIES_VALUE_FIELD_NAME,type:n.FieldType.number},{name:"latitude",type:n.FieldType.number},{name:"longitude",type:n.FieldType.number}]}),!t)return[2,r];l=[],u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.stravaApi.getActivityStreams({id:e.id,streamType:_.LatLng})];case 2:if(o=u.sent(),l=o[_.LatLng].data,s=Object(n.dateTime)(e.start_date).unix(),!(c=null===(i=o.time)||void 0===i?void 0:i.data))throw new Error("Time field not found");for(r.addField({name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time}),d=t.start_index;d<t.end_index;d++)r.add(((m={latitude:l[d][0],longitude:l[d][1]})[n.TIME_SERIES_VALUE_FIELD_NAME]=1,m[n.TIME_SERIES_TIME_FIELD_NAME]=1e3*(s+c[d]),m));return[3,4];case 3:return u.sent(),[3,4];case 4:return[2,r]}}))}))},t.prototype.metricFindQuery=function(e,t){return o(this,void 0,Promise,(function(){var t,a,n,r,i,l,o,c,d,m;return u(this,(function(u){switch(u.label){case 0:return e.queryType!==E.SegmentEffort?[3,2]:(t=Object(A.getTemplateSrv)().replace(e.activityId),[4,this.stravaApi.getActivity({id:t,include_all_efforts:!0})]);case 1:a=u.sent(),n=[];try{for(r=s(a.segment_efforts),i=r.next();!i.done;i=r.next())l=i.value,n.push({value:l.id,text:l.name})}catch(e){d={error:e}}finally{try{i&&!i.done&&(m=r.return)&&m.call(r)}finally{if(d)throw d.error}}return[2,n];case 2:return o=e.limit||100,[4,this.stravaApi.getActivities({limit:o})];case 3:return c=u.sent(),c=this.filterActivities(c,e.activityType),[2,c.map((function(e){return{value:e.id,text:e.name}}))]}}))}))},t.prototype.testDatasource=function(){var e;return o(this,void 0,void 0,(function(){var t,a,n,r;return u(this,(function(i){switch(i.label){case 0:if(this.stravaAuthType===m.RefreshToken)return[3,4];if(!(t=this.getAuthCodeFromLocation()))return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.stravaApi.exchangeToken(t)];case 2:return i.sent(),[3,4];case 3:return i.sent(),[3,4];case 4:return i.trys.push([4,8,,9]),[4,this.stravaApi.resetAccessToken()];case 5:return i.sent(),[4,this.stravaApi.resetCache()];case 6:return i.sent(),[4,this.stravaApi.getAuthenticatedAthlete()];case 7:return(a=i.sent())?[2,{status:"success",message:"Data source is working. Authenticated as "+a.firstname+" "+a.lastname+"."}]:[2,{status:"error",message:"Cannot get authenticated user."}];case 8:return n=i.sent(),[2,{status:"error",message:"Cannot connect to Strava API"+((r=(null===(e=null==n?void 0:n.data)||void 0===e?void 0:e.message)||"")?": "+r:"")}];case 9:return[2]}}))}))},t.prototype.getAuthCodeFromLocation=function(){var e=/code=([\w]+)/.exec(window.location.search);return e&&e.length&&e[1]},t.prototype.filterActivities=function(e,t){return t?e.filter((function(e){return"Other"===t?"Run"!==e.type&&"Ride"!==e.type:e.type===t})):e},t.prototype.transformActivitiesToTimeseries=function(e,t,a){var r,i,l=[];try{for(var o=s(e),u=o.next();!u.done;u=o.next()){var c=u.value,d=re(c,t.activityStat,this.measurementPreference);l.push([d,Object(n.dateTime)(c.start_date).valueOf()])}}catch(e){r={error:e}}finally{try{u&&!u.done&&(i=o.return)&&i.call(o)}finally{if(r)throw r.error}}if(l.sort((function(e,t){return e[1]-t[1]})),t.interval!==h.No){var m=t.interval&&t.interval!==h.Auto?function(e){switch(e.interval){case h.Hour:return 36e5;case h.Day:return 864e5;case h.Week:return V;case h.Month:default:return H}}(t):function(e){var t=1e3*(e.to.unix()-e.from.unix());switch(!0){case t<=3456e5:return 36e5;case t<=7776e6:return 864e5;case t<=31536e6:return V;default:return H}}(a);l=m>=H?function(e,t){return U(e,t,null,Y,$,J)}(l,a):m===V?function(e,t){return U(e,t,null,z,K,J)}(l,a):function(e,t,a){return U(e,t,a,B,Q,J)}(l,a,m)}for(var f={name:n.TIME_SERIES_TIME_FIELD_NAME,type:n.FieldType.time,config:{},values:new n.ArrayVector},v={name:n.TIME_SERIES_VALUE_FIELD_NAME,type:n.FieldType.number,config:{unit:ie(t.activityStat,this.measurementPreference)},values:new n.ArrayVector},p=0;p<l.length;p++){var g=l[p];f.values.add(g[1]),v.values.add(g[0])}var y=(t.activityType?t.activityType+"_":"")+t.activityStat;return new n.MutableDataFrame({name:y,refId:t.refId,fields:[f,v]})},t.prototype.transformActivitiesToTable=function(e,t){var a,r,i=this.measurementPreference===f.Feet?"lengthmi":"lengthm",l=this.measurementPreference===f.Feet?"lengthft":"lengthm",o=new n.MutableDataFrame({refId:t.refId,fields:[{name:"time",type:n.FieldType.time},{name:"name",type:n.FieldType.string},{name:"distance",type:n.FieldType.number,config:{unit:i}},{name:"moving time",type:n.FieldType.number,config:{unit:"dthms"}},{name:"elapsed time",type:n.FieldType.number,config:{unit:"dthms"}},{name:"heart rate",type:n.FieldType.number,config:{unit:"none",decimals:0}},{name:"elevation gain",type:n.FieldType.number,config:{unit:l,decimals:0}},{name:"kilojoules",type:n.FieldType.number,config:{unit:"joule"}},{name:"type",type:n.FieldType.string},{name:"id",type:n.FieldType.string,config:{unit:"none",custom:{hidden:!0}}},{name:"time_from",type:n.FieldType.number,config:{unit:"none",decimals:0,custom:{hidden:!0}}},{name:"time_to",type:n.FieldType.number,config:{unit:"none",decimals:0,custom:{hidden:!0}}}]});null===(a=t.extendedStats)||void 0===a||a.forEach((function(e){o.addField({name:e})}));for(var u=function(a){var i=e[a],l={time:Object(n.dateTime)(i.start_date),name:i.name,distance:X(i.distance,s.measurementPreference),"moving time":i.moving_time,"elapsed time":i.elapsed_time,"heart rate":i.average_heartrate,"elevation gain":Z(i.total_elevation_gain,s.measurementPreference),kilojoules:i.kilojoules,type:i.type,id:i.id,time_from:1e3*Object(n.dateTime)(i.start_date).unix(),time_to:1e3*(Object(n.dateTime)(i.start_date).unix()+i.elapsed_time)};null===(r=t.extendedStats)||void 0===r||r.forEach((function(e){var t=i[e];t&&(l[e]=t)})),o.add(l)},s=this,c=0;c<e.length;c++)u(c);return o},t.prototype.transformActivitiesToGeomap=function(e,t){var a,r,i=new n.MutableDataFrame({name:"activities",refId:t.refId,fields:[{name:"name",type:n.FieldType.string},{name:"latitude",type:n.FieldType.number},{name:"longitude",type:n.FieldType.number},{name:"value",type:n.FieldType.number,config:{unit:ie(t.activityStat,this.measurementPreference)}}]});try{for(var l=s(e),o=l.next();!o.done;o=l.next()){var u=o.value,c=W(u),d=c?c[0]:u.start_latlng[0],m=c?c[1]:u.start_latlng[1];d&&m&&i.add({name:u.name,value:re(u,t.activityStat,this.measurementPreference),latitude:d,longitude:m})}}catch(e){a={error:e}}finally{try{o&&!o.done&&(r=l.return)&&r.call(l)}finally{if(a)throw a.error}}return i},t.prototype.transformActivitiesToHeatmap=function(e,t){var a,r,i,l=new n.MutableDataFrame({name:"heatmap",refId:t.refId,fields:[{name:"latitude",type:n.FieldType.number},{name:"longitude",type:n.FieldType.number},{name:"value",type:n.FieldType.number}]});try{for(var o=s(e),u=o.next();!u.done;u=o.next()){var c=u.value,d=null===(i=null==c?void 0:c.map)||void 0===i?void 0:i.summary_polyline;if(d)for(var m=C.decode(d),f=0;f<m.length;f++)l.add({latitude:m[f][0],longitude:m[f][1],value:1})}}catch(e){a={error:e}}finally{try{u&&!u.done&&(r=o.return)&&r.call(o)}finally{if(a)throw a.error}}return l},t}(n.DataSourceApi);function W(e){if(!e.map||!e.map.summary_polyline)return null;var t=e.map.summary_polyline,a=C.decode(t);return a&&a.length?a[Math.floor(a.length/2)]:null}var V=6048e5,H=24192e5;var J=function(e){return e.reduce((function(e,t){return e+t}))};function U(e,t,a,n,r,i){if(0===e.length)return[];for(var l,o,u=1e3*t.from.unix(),s=1e3*t.to.unix(),c=[],d=[],m=e.length?n(u,a):0,f=m,v=0;v<e.length;v++)if((f=n((o=e[v])[1],a))===m)d.push(o[0]);else if(f>m){for(l=d.length?i(d):null,c.push([l,m]),m=r(m,a);m<f;)c.push([null,m]),m=r(m,a);d=[o[0]]}for(l=i(d),c.push([l,m]),m=r(m,a);m<s;)c.push([null,m]),m=r(m,a);return c}function B(e,t){return Math.floor(e/t)*t}function Q(e,t){return e+t}function Y(e){return 1e3*Object(n.dateTime)(e).startOf("month").unix()}function $(e){return 1e3*Object(n.dateTime)(e).add(1,"month").unix()}function z(e){var t=e-3456e5;return Math.floor(t/V)*V+3456e5}function K(e){return e+V}function X(e,t){return t===f.Feet?P(e):e}function Z(e,t){return t===f.Feet?R(e):e}function ee(e,t){var a=M(e);return t===f.Feet?P(1e3*a):a}function te(e){return e===f.Feet?"velocitymph":"velocitykmh"}function ae(e){return e===f.Feet?"lengthft":"lengthm"}function ne(e,t){var a=j(e);return t===f.Feet?x(a):a}function re(e,t,a){return t===g.Distance?X(e.distance,a):t===g.ElevationGain?Z(e.total_elevation_gain,a):e[t]}function ie(e,t){return e===g.Distance?t===f.Feet?"lengthmi":"lengthm":e===g.ElevationGain?t===f.Feet?"lengthft":"lengthm":e===g.ElapsedTime||e===g.MovingTime?"dthms":e===g.AveragePower?"watt":"none"}var le=[{value:"",label:"All"},{value:"Run",label:"Run"},{value:"Ride",label:"Ride"},{value:"Other",label:"Other"}],oe=function(e){function t(t){var a=e.call(this,t)||this;a.queryTypes=[{value:E.Activity,label:"Activity"},{value:E.SegmentEffort,label:"Segment effort"}],a.onQueryTypeChange=function(e){var t=e.value||E.Activity,n=l(l({},a.props.query),{queryType:t});a.props.onChange(n,"Strava - "+t)},a.onActivityTypeChange=function(e){var t=e.value||"",n=l(l({},a.props.query),{activityType:t});a.props.onChange(n,"Strava - "+a.props.query.queryType)},a.onLimitStateChange=function(e){var t=Number(e.currentTarget.value||"");a.setState({limit:t})},a.onLimitChange=function(e){var t=Number(e.currentTarget.value||""),n=l(l({},a.props.query),{limit:t});a.props.onChange(n,"Strava - "+a.props.query.queryType)},a.onActivityIdChange=function(e){var t=e.currentTarget.value||"",n=l(l({},a.props.query),{activityId:t});a.props.onChange(n,"Strava - "+a.props.query.queryType)};var n=a.props.query;return a.state={limit:n.limit||100},a}return i(t,e),t.prototype.render=function(){var e=this.props.query,t=this.state.limit;return S.a.createElement(S.a.Fragment,null,S.a.createElement("div",{className:"gf-form max-width-21"},S.a.createElement(w.InlineFormLabel,{width:10},"Query Type"),S.a.createElement(w.Select,{width:20,value:e.queryType,options:this.queryTypes,onChange:this.onQueryTypeChange})),S.a.createElement("div",{className:"gf-form-inline"},e.queryType===E.Activity&&S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineField,{label:"Activity Type",labelWidth:20},S.a.createElement(w.Select,{width:16,value:e.activityType,onChange:this.onActivityTypeChange,options:le})),S.a.createElement(w.InlineField,{label:"Limit",labelWidth:10,tooltip:"API query limit. Set to 0 for no limit."},S.a.createElement(w.Input,{type:"number",value:t,onChange:this.onLimitStateChange,onBlur:this.onLimitChange,width:12}))),e.queryType===E.SegmentEffort&&S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineField,{label:"Activity",labelWidth:20,tooltip:"Activity id"},S.a.createElement(w.Input,{value:e.activityId,onChange:this.onActivityIdChange,onBlur:this.onActivityIdChange,width:30})))))},t}(T.PureComponent),ue=/code=([\w]+)/,se=[{label:"OAuth",value:m.OAuth},{label:"Refresh token",value:m.RefreshToken}],ce=function(e){function t(a){var n=e.call(this,a)||this;n.updateDatasource=function(e){return o(n,void 0,void 0,(function(){var t,a;return u(this,(function(n){for(t in e.jsonData)0===e.jsonData[t].length&&delete e.jsonData[t];for(a in e.secureJsonData)0===e.secureJsonData[a].length&&delete e.secureJsonData[a];return this.props.onOptionsChange(l({},e)),[2]}))}))},n.onCacheTTLChange=function(e){n.updateDatasource(l(l({},n.state.config),{jsonData:l(l({},n.state.config.jsonData),{cacheTTL:e})}))},n.onResetClientSecret=function(){n.updateDatasource(l(l({},n.state.config),{secureJsonFields:l(l({},n.state.config.secureJsonFields),{clientSecret:!1})}))},n.onResetRefreshToken=function(){n.updateDatasource(l(l({},n.state.config),{secureJsonFields:l(l({},n.state.config.secureJsonFields),{refreshToken:!1})}))},n.onAccessTokenChange=function(e){n.updateDatasource(l(l({},n.state.config),{secureJsonData:l(l({},n.state.config.secureJsonData),{accessToken:e})}))},n.onClientIDChange=function(e){n.updateDatasource(l(l({},n.state.config),{jsonData:l(l({},n.state.config.jsonData),{clientID:e})}))},n.onClientSecretChange=function(e){n.updateDatasource(l(l({},n.state.config),{secureJsonData:l(l({},n.state.config.secureJsonData),{clientSecret:e})}))},n.onRefreshTokenChange=function(e){n.updateDatasource(l(l({},n.state.config),{secureJsonData:l(l({},n.state.config.secureJsonData),{refreshToken:e})}))},n.onAuthCodeChange=function(e){n.updateDatasource(l(l({},n.state.config),{secureJsonData:l(l({},n.state.config.secureJsonData),{authCode:e})}))},n.onAuthTypeChange=function(e){n.updateDatasource(l(l({},n.state.config),{jsonData:l(l({},n.state.config.jsonData),{stravaAuthType:e})}))},n.isLocationContainsCode=function(){return ue.test(window.location.search)},n.isLocationContainsError=function(){return/error=/.test(window.location.search)},n.getConnectWithStravaHref=function(){var e=window.location.origin+window.location.pathname;return"https://www.strava.com/oauth/authorize?client_id="+n.state.config.jsonData.clientID+"&response_type=code&redirect_uri="+e+"&approval_prompt=force&scope=read_all,profile:read_all,activity:read_all"};var r=n.props.options;return n.state={config:t.defaults(r)},n.updateDatasource(n.state.config),n}return i(t,e),t.getDerivedStateFromProps=function(e,a){return l(l({},a),{config:t.defaults(e.options)})},t.prototype.render=function(){var e,t,a,n,r=this,i=this.state.config,l=this.getConnectWithStravaHref();return S.a.createElement(S.a.Fragment,null,S.a.createElement("h2",{className:"page-heading"},"Strava API Details"),S.a.createElement("div",{className:"gf-form-group"},S.a.createElement("h5",null,"Auth type"),S.a.createElement(w.RadioButtonGroup,{options:se,value:i.jsonData.stravaAuthType,onChange:this.onAuthTypeChange})),S.a.createElement("div",{className:"gf-form-group"},S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineField,{label:"Client ID",labelWidth:16},S.a.createElement(w.Input,{width:50,value:i.jsonData.clientID||"",onChange:function(e){return r.onClientIDChange(e.target.value)}}))),S.a.createElement(w.InlineFieldRow,null,i.secureJsonFields&&i.secureJsonFields.clientSecret?S.a.createElement(S.a.Fragment,null,S.a.createElement(w.InlineField,{label:"Client Secret",labelWidth:16},S.a.createElement(w.Input,{placeholder:"Configured",width:50,disabled:!0})),S.a.createElement(w.InlineField,null,S.a.createElement(w.Button,{variant:"secondary",type:"button",onClick:this.onResetClientSecret},"Reset"))):S.a.createElement(w.InlineField,{label:"Client Secret",labelWidth:16},S.a.createElement(w.Input,{width:50,value:(null===(e=i.secureJsonData)||void 0===e?void 0:e.clientSecret)||"",onChange:function(e){return r.onClientSecretChange(e.target.value)}}))),(null===(t=i.jsonData)||void 0===t?void 0:t.stravaAuthType)===m.RefreshToken&&S.a.createElement(w.InlineFieldRow,null,i.secureJsonFields&&i.secureJsonFields.refreshToken?S.a.createElement(S.a.Fragment,null,S.a.createElement(w.InlineField,{label:"Refresh Token",labelWidth:16},S.a.createElement(w.Input,{placeholder:"Configured",width:50,disabled:!0})),S.a.createElement(w.InlineField,null,S.a.createElement(w.Button,{variant:"secondary",type:"button",onClick:this.onResetRefreshToken},"Reset"))):S.a.createElement(w.InlineField,{label:"Refresh Token",labelWidth:16},S.a.createElement(w.Input,{width:50,value:(null===(a=i.secureJsonData)||void 0===a?void 0:a.refreshToken)||"",onChange:function(e){return r.onRefreshTokenChange(e.target.value)}})))),(null===(n=i.jsonData)||void 0===n?void 0:n.stravaAuthType)!==m.RefreshToken&&S.a.createElement("div",{className:"gf-form-group"},S.a.createElement("a",{type:"button",href:l},S.a.createElement("img",{src:"public/plugins/grafana-strava-datasource/img/btn_strava_connectwith_orange.svg"}))),S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineField,{label:"Cache TTL",labelWidth:16},S.a.createElement(w.Input,{width:10,value:i.jsonData.cacheTTL||"",placeholder:"1h",onChange:function(e){return r.onCacheTTLChange(e.target.value)}}))))},t.defaults=function(e){return e.hasOwnProperty("secureJsonData")||(e.secureJsonData={}),e.hasOwnProperty("jsonData")||(e.jsonData={}),e.hasOwnProperty("secureJsonFields")||(e.secureJsonFields={}),e.jsonData.stravaAuthType||(e.jsonData.stravaAuthType=m.OAuth),e},t}(T.PureComponent),de=a(5);function me(e,t,a){void 0===t&&(t=[]),void 0===a&&(a={loading:!1});var n,r,i=Object(T.useRef)(0),l=(n=Object(T.useRef)(!1),r=Object(T.useCallback)((function(){return n.current}),[]),Object(T.useEffect)((function(){return n.current=!0,function(){n.current=!1}}),[]),r),o=Object(T.useState)(a),u=o[0],s=o[1],c=Object(T.useCallback)((function(){for(var t=[],a=0;a<arguments.length;a++)t[a]=arguments[a];var n=++i.current;return u.loading||s((function(e){return Object(de.a)(Object(de.a)({},e),{loading:!0})})),e.apply(void 0,t).then((function(e){return l()&&n===i.current&&s({value:e,loading:!1}),e}),(function(e){return l()&&n===i.current&&s({error:e,loading:!1}),e}))}),t);return[u,c]}var fe,ve,he,pe,ge=a(4),ye=Object(w.stylesFactory)((function(e){return{athleteLabel:Object(ge.css)(fe||(fe=d(["\n      height: ","px;\n      padding: 2px;\n      margin-right: 0px;\n      border-radius: ",";\n      background-color: ",";\n    "],["\n      height: ","px;\n      padding: 2px;\n      margin-right: 0px;\n      border-radius: ",";\n      background-color: ",";\n    "])),e.spacing.formInputHeight,e.border.radius.md,e.colors.bg2),athleteAvatar:Object(ge.css)(ve||(ve=d(["\n      height: 28px;\n      border-radius: 50%;\n    "],["\n      height: 28px;\n      border-radius: 50%;\n    "]))),athletePlaceholder:Object(ge.css)(he||(he=d(["\n      width: 28px;\n    "],["\n      width: 28px;\n    "]))),spinner:Object(ge.css)(pe||(pe=d(["\n      width: 28px;\n      height: ","px;\n      padding: 2px;\n      border-radius: ",";\n      background-color: ",";\n    "],["\n      width: 28px;\n      height: ","px;\n      padding: 2px;\n      border-radius: ",";\n      background-color: ",";\n    "])),e.spacing.formInputHeight,e.border.radius.md,e.palette.dark4)}})),be=function(e){var t=e.athlete,a=e.isLoading,n=ye(Object(w.useTheme)()),r=Object(ge.cx)("filter-table__avatar",n.athleteAvatar);return a?S.a.createElement("div",{className:"gf-form"},S.a.createElement("div",{className:n.spinner},S.a.createElement(w.Spinner,{size:20})),S.a.createElement(w.InlineFormLabel,null,"Â ")):S.a.createElement("div",{className:"gf-form"},(null==t?void 0:t.profile_medium)?S.a.createElement("div",{className:n.athleteLabel},S.a.createElement("img",{className:r,src:t.profile_medium})):S.a.createElement("div",{className:n.athletePlaceholder}),S.a.createElement(w.InlineFormLabel,null,null==t?void 0:t.firstname," ",null==t?void 0:t.lastname))},_e=[{value:p.Activities,label:"Activities",description:"Athlete Activities"},{value:p.Activity,label:"Activity",description:"Individual activity"},{value:p.SegmentEffort,label:"Segment effort",description:"Activity segment efforts"}],Ee=[{value:g.Distance,label:"Distance"},{value:g.ElapsedTime,label:"Elapsed Time"},{value:g.MovingTime,label:"Moving Time"},{value:g.ElevationGain,label:"Elevation Gain"},{value:g.AverageHeartRate,label:"Average Heart Rate"},{value:g.AveragePower,label:"Average Power"},{value:g.WeightedAveragePower,label:"Weighted Average Power"}],Te=[{value:null,label:"All"},{value:"Run",label:"Run"},{value:"Ride",label:"Ride"},{value:"Other",label:"Other"}],Se=[{value:y.Graph,label:"Graph"},{value:y.Splits,label:"Splits"},{value:y.Stats,label:"Stats"},{value:y.Segments,label:"Segments"},{value:y.Geomap,label:"Geomap"}],we=[{value:y.Graph,label:"Graph"},{value:y.Geomap,label:"Geomap"}],Ae=[{value:_.HeartRate,label:"Heart Rate"},{value:_.Velocity,label:"Speed"},{value:_.Pace,label:"Pace"},{value:_.WattsCalc,label:"Est Power"},{value:_.Watts,label:"Watts"},{value:_.Cadence,label:"Cadence"},{value:_.Altitude,label:"Altitude"},{value:_.GradeSmooth,label:"Gradient"}],Fe=[{value:b.Pace,label:"Pace"},{value:b.HeartRate,label:"Heart Rate"},{value:b.Speed,label:"Speed"},{value:b.ElapsedTime,label:"Elapsed Time"},{value:b.MovingTime,label:"Moving Time"}],Ie=[{label:"Time series",value:v.TimeSeries},{label:"Table",value:v.Table},{label:"Geomap",value:v.WorldMap},{label:"Heatmap",value:v.Heatmap}],De=[{label:"Auto",value:h.Auto},{label:"No",value:h.No},{label:"Hour",value:h.Hour},{label:"Day",value:h.Day},{label:"Week",value:h.Week},{label:"Month",value:h.Month}],Ce=[{label:"achievement_count",value:"achievement_count"},{label:"top_achievement",value:"top_achievement"},{label:"average_speed",value:"average_speed"},{label:"average_watts",value:"average_watts"},{label:"weighted_average_watts",value:"weighted_average_watts"},{label:"calories",value:"calories"},{label:"comment_count",value:"comment_count"},{label:"commute",value:"commute"},{label:"device_watts",value:"device_watts"},{label:"elev_high",value:"elev_high"},{label:"elev_low",value:"elev_low"},{label:"has_kudoed",value:"has_kudoed"},{label:"kudos_count",value:"kudos_count"},{label:"location_city",value:"location_city"},{label:"location_country",value:"location_country"},{label:"location_state",value:"location_state"},{label:"manual",value:"manual"},{label:"max_heartrate",value:"max_heartrate"},{label:"max_speed",value:"max_speed"},{label:"pr_count",value:"pr_count"},{label:"start_date",value:"start_date"},{label:"start_date_local",value:"start_date_local"},{label:"start_latitude",value:"start_latitude"},{label:"start_longitude",value:"start_longitude"},{label:"trainer",value:"trainer"},{label:"workout_type",value:"workout_type"},{label:"device_name",value:"device_name"},{label:"gear_id",value:"gear_id"},{label:"gear_name",value:"gear_name"},{label:"gear_nickname",value:"device_nickname"},{label:"gear_distance",value:"gear_distance"}],Re=[{label:"start_date",value:"start_date"},{label:"name",value:"name"},{label:"distance",value:"distance"},{label:"pace",value:"pace"},{label:"moving_time",value:"moving_time"},{label:"elapsed_time",value:"elapsed_time"},{label:"average_heartrate",value:"average_heartrate"},{label:"total_elevation_gain",value:"total_elevation_gain"},{label:"kilojoules",value:"kilojoules"},{label:"type",value:"type"},{label:"id",value:"id"}].concat(Ce),Pe={refId:"",queryType:p.Activities,activityType:null,activityStat:g.Distance,format:v.TimeSeries,interval:h.Auto,activityData:y.Graph,activityGraph:_.Pace,splitStat:b.Speed,singleActivityStat:"name",extendedStats:[],fitToTimeRange:!0,segmentData:y.Graph,segmentGraph:_.Pace};a.d(t,"plugin",(function(){return je}));var xe=function(){function e(){}return e.templateUrl="partials/annotations.editor.html",e}(),je=new n.DataSourcePlugin(N).setConfigEditor(ce).setQueryEditor((function(e){var t=e.query,a=e.datasource,r=e.onChange,i=e.onRunQuery;t=l(l({},Pe),t);var s=c(Object(T.useState)(a.athlete),2),d=s[0],m=s[1],f=c(me((function(){return o(void 0,void 0,void 0,(function(){var e;return u(this,(function(t){switch(t.label){case 0:return[4,a.stravaApi.getAuthenticatedAthlete()];case 1:return e=t.sent(),m(e),[2,e]}}))}))})),2),h=f[0].loading,g=f[1],b=c(me((function(){return o(void 0,void 0,void 0,(function(){return u(this,(function(e){switch(e.label){case 0:return[4,C(t.activityType)];case 1:return[2,e.sent()]}}))}))}),[t.activityType]),2),_=b[0].value,E=b[1],F=c(me((function(){return o(void 0,void 0,void 0,(function(){var e,a;return u(this,(function(n){switch(n.label){case 0:return e=Object(A.getTemplateSrv)().replace(null===(a=t.activityId)||void 0===a?void 0:a.toString()),[4,R(e)];case 1:return[2,n.sent()]}}))}))}),[t.activityType]),2),I=F[0].value,D=F[1];Object(T.useEffect)((function(){a.athlete||g(),E(),t.queryType===p.SegmentEffort&&D()}),[a.athlete,g,E]);var C=function(e){return o(void 0,void 0,Promise,(function(){var t,r;return u(this,(function(i){switch(i.label){case 0:return[4,a.stravaApi.getActivities({limit:100})];case 1:return t=i.sent(),t=a.filterActivities(t,e),r=t.map((function(e){return{value:e.id,label:e.name,description:Object(n.dateTime)(e.start_date_local).format("YYYY-MM-DD HH:mm")+" ("+e.type+")"}})),[2,Object(A.getTemplateSrv)().getVariables().map((function(e){return{value:"$"+e.name,label:"$"+e.name,description:"Variable"}})).concat(r)]}}))}))},R=function(e){return o(void 0,void 0,Promise,(function(){var t,r,i;return u(this,(function(l){switch(l.label){case 0:t=[],l.label=1;case 1:return l.trys.push([1,3,,4]),[4,a.stravaApi.getActivity({id:e,include_all_efforts:!0})];case 2:return r=l.sent(),t=null===(i=r.segment_efforts)||void 0===i?void 0:i.map((function(e){return{value:e.id,label:e.name,description:""+Object(n.dateTime)(e.start_date).format("YYYY-MM-DD HH:mm")}})),[3,4];case 3:return l.sent(),[3,4];case 4:return[2,Object(A.getTemplateSrv)().getVariables().map((function(e){return{value:"$"+e.name,label:"$"+e.name,description:"Variable"}})).concat(t)]}}))}))},P=function(){return Fe.find((function(e){return e.value===t.splitStat}))},x=function(){return Re.find((function(e){return e.value===t.singleActivityStat}))||{label:t.singleActivityStat,value:t.singleActivityStat}},j=function(){return t.selectedActivity},M=function(e){return function(a){var n;a.value&&G(l(l({},t),((n={})[e]=a.value,n)))}},O=function(e){G(l(l({},t),{fitToTimeRange:!t.fitToTimeRange}))},k=function(e){void 0!==e.value&&G(l(l({},t),{activityId:e.value,selectedActivity:e}))},q=function(e){void 0!==e.value&&G(l(l({},t),{segmentEffortId:e.value,selectedSegmentEffort:e}))},L=function(e){if(e){var a=[];e.forEach((function(e){return e.value&&a.push(e.value)})),G(l(l({},t),{extendedStats:a}))}},G=function(e){r(e),i()},N=_e.find((function(e){return e.value===t.queryType}));return S.a.createElement(S.a.Fragment,null,S.a.createElement(w.InlineFieldRow,null,S.a.createElement(be,{athlete:d,isLoading:h}),S.a.createElement(w.InlineField,{label:"Query",labelWidth:10},S.a.createElement(w.Select,{isSearchable:!1,width:20,value:N,options:_e,onChange:M("queryType")})),S.a.createElement(w.InlineField,{label:"Activity type",labelWidth:12},S.a.createElement(w.Select,{isSearchable:!1,width:16,value:Te.find((function(e){return e.value===t.activityType})),options:Te,onChange:function(e){return o(void 0,void 0,void 0,(function(){return u(this,(function(a){return void 0!==e.value&&(G(l(l({},t),{activityType:e.value})),E()),[2]}))}))}})),S.a.createElement("div",{className:"gf-form gf-form--grow"},S.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))),(null==N?void 0:N.value)===p.Activities&&S.a.createElement(S.a.Fragment,null,S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineFormLabel,{width:12},"Â "),S.a.createElement(w.InlineField,{label:"Format",labelWidth:10},S.a.createElement(w.Select,{isSearchable:!1,width:16,options:Ie,onChange:M("format"),value:Ie.find((function(e){return e.value===t.format}))})),t.format!==v.Heatmap&&S.a.createElement(w.InlineField,{label:"Stat",labelWidth:12},S.a.createElement(w.Select,{isSearchable:!1,width:16,value:Ee.find((function(e){return e.value===t.activityStat})),options:Ee,onChange:M("activityStat")})),t.format===v.TimeSeries&&S.a.createElement(w.InlineField,{label:"Interval",labelWidth:12},S.a.createElement(w.Select,{isSearchable:!1,width:16,options:De,onChange:M("interval"),value:De.find((function(e){return e.value===t.interval}))})),S.a.createElement("div",{className:"gf-form gf-form--grow"},S.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))),t.format===v.Table&&S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineFormLabel,{width:12},"Â "),S.a.createElement(w.InlineField,{label:"Extended Stats",labelWidth:14},S.a.createElement(w.MultiSelect,{isSearchable:!0,isClearable:!0,value:t.extendedStats,options:Ce,onChange:L})),S.a.createElement("div",{className:"gf-form gf-form--grow"},S.a.createElement("div",{className:"gf-form-label gf-form-label--grow"})))),(null==N?void 0:N.value)===p.Activity&&S.a.createElement(S.a.Fragment,null,S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineFormLabel,{width:12},"Â "),S.a.createElement(w.InlineField,{label:"Activity",labelWidth:10},S.a.createElement(w.Select,{isSearchable:!0,width:30,value:j(),options:_,onChange:k})),S.a.createElement(w.InlineField,{label:"Data",labelWidth:10},S.a.createElement(w.Select,{isSearchable:!1,width:16,value:Se.find((function(e){return e.value===t.activityData})),options:Se,onChange:M("activityData")})),t.activityData===y.Graph&&S.a.createElement(w.InlineField,null,S.a.createElement(w.Select,{isSearchable:!1,width:16,value:Ae.find((function(e){return e.value===t.activityGraph})),options:Ae,onChange:M("activityGraph")})),t.activityData===y.Splits&&S.a.createElement(w.InlineField,null,S.a.createElement(w.Select,{isSearchable:!1,width:16,value:P(),options:Fe,onChange:M("splitStat")})),t.activityData===y.Stats&&S.a.createElement(w.InlineField,null,S.a.createElement(w.Select,{isSearchable:!0,allowCustomValue:!0,width:20,value:x(),options:Re,onChange:M("singleActivityStat")})),S.a.createElement(w.InlineField,{label:"Fit to range",labelWidth:10},S.a.createElement(w.InlineSwitch,{value:t.fitToTimeRange||!1,onChange:O})),S.a.createElement("div",{className:"gf-form gf-form--grow"},S.a.createElement("div",{className:"gf-form-label gf-form-label--grow"})))),(null==N?void 0:N.value)===p.SegmentEffort&&S.a.createElement(S.a.Fragment,null,S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineFormLabel,{width:12},"Â "),S.a.createElement(w.InlineField,{label:"Activity",labelWidth:10},S.a.createElement(w.Select,{isSearchable:!0,width:32,value:j(),options:_,onChange:k})),S.a.createElement(w.InlineField,{label:"Segment effort",labelWidth:14},S.a.createElement(w.Select,{isSearchable:!0,width:32,value:t.selectedSegmentEffort,options:I,onChange:q})),S.a.createElement("div",{className:"gf-form gf-form--grow"},S.a.createElement("div",{className:"gf-form-label gf-form-label--grow"}))),S.a.createElement(w.InlineFieldRow,null,S.a.createElement(w.InlineFormLabel,{width:12},"Â "),S.a.createElement(w.InlineField,{label:"Data",labelWidth:10},S.a.createElement(w.Select,{isSearchable:!1,width:16,value:we.find((function(e){return e.value===t.segmentData})),options:we,onChange:M("segmentData")})),t.segmentData===y.Graph&&S.a.createElement(w.InlineField,null,S.a.createElement(w.Select,{isSearchable:!1,width:16,value:Ae.find((function(e){return e.value===t.segmentGraph})),options:Ae,onChange:M("segmentGraph")})),t.activityData===y.Splits&&S.a.createElement(w.InlineField,null,S.a.createElement(w.Select,{isSearchable:!1,width:16,value:P(),options:Fe,onChange:M("splitStat")})),t.activityData===y.Stats&&S.a.createElement(w.InlineField,null,S.a.createElement(w.Select,{isSearchable:!0,allowCustomValue:!0,width:20,value:x(),options:Re,onChange:M("singleActivityStat")})),S.a.createElement(w.InlineField,{label:"Fit to range",labelWidth:10},S.a.createElement(w.InlineSwitch,{value:t.fitToTimeRange||!1,onChange:O})),S.a.createElement("div",{className:"gf-form gf-form--grow"},S.a.createElement("div",{className:"gf-form-label gf-form-label--grow"})))))})).setAnnotationQueryCtrl(xe).setVariableQueryEditor(oe)}])}));
//# sourceMappingURL=module.js.map